"use strict";(globalThis.webpackChunkaicraft_website=globalThis.webpackChunkaicraft_website||[]).push([[34],{3067(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"api/simd","title":"SIMD Kernels","description":"#include  and #include","source":"@site/docs/api/simd.md","sourceDirName":"api","slug":"/api/simd","permalink":"/Aicraft/docs/api/simd","draft":false,"unlisted":false,"editUrl":"https://github.com/TobiasTesauri/Aicraft/tree/main/docs/api/simd.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"SIMD Kernels"},"sidebar":"docsSidebar","previous":{"title":"Memory","permalink":"/Aicraft/docs/api/memory"},"next":{"title":"Quantization","permalink":"/Aicraft/docs/api/quantize"}}');var s=t(4848),i=t(8453);const c={sidebar_position:8,title:"SIMD Kernels"},r="SIMD Math API",l={},o=[{value:"Architecture Detection",id:"architecture-detection",level:2},{value:"Element-wise Operations",id:"element-wise-operations",level:2},{value:"Reductions",id:"reductions",level:2},{value:"GEMM (General Matrix Multiply)",id:"gemm-general-matrix-multiply",level:2},{value:"BLIS-style Algorithm",id:"blis-style-algorithm",level:3},{value:"Micro-kernels",id:"micro-kernels",level:3},{value:"Threading",id:"threading",level:3},{value:"Transpose",id:"transpose",level:2},{value:"Fast Math (Approximations)",id:"fast-math-approximations",level:2},{value:"NEON Transcendentals",id:"neon-transcendentals",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"simd-math-api",children:"SIMD Math API"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"#include <aicraft/simd_math.h>"})," and ",(0,s.jsx)(n.code,{children:"#include <aicraft/fast_math.h>"})]}),"\n",(0,s.jsx)(n.h2,{id:"architecture-detection",children:"Architecture Detection"}),"\n",(0,s.jsx)(n.p,{children:"Aicraft automatically selects the best SIMD backend at compile time:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"AVX-512  \u2192  AVX2  \u2192  SSE4.2  \u2192  ARM NEON  \u2192  Scalar\r\n(best)                                        (fallback)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Detection uses compiler-defined macros: ",(0,s.jsx)(n.code,{children:"__AVX512F__"}),", ",(0,s.jsx)(n.code,{children:"__AVX2__"}),", ",(0,s.jsx)(n.code,{children:"__SSE4_2__"}),", ",(0,s.jsx)(n.code,{children:"__ARM_NEON"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"element-wise-operations",children:"Element-wise Operations"}),"\n",(0,s.jsxs)(n.p,{children:["All functions process arrays of ",(0,s.jsx)(n.code,{children:"n"})," floats with automatic SIMD vectorization:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"void ac_simd_add(const float* a, const float* b, float* c, ac_size n);    // c = a + b\r\nvoid ac_simd_mul(const float* a, const float* b, float* c, ac_size n);    // c = a * b\r\nvoid ac_simd_scale(const float* a, float s, float* c, ac_size n);         // c = a * s\r\nvoid ac_simd_fma(const float* a, const float* b, float s, float* c, ac_size n); // c = a*b + s\r\nvoid ac_simd_relu(const float* a, float* c, ac_size n);                   // c = max(0, a)\r\nvoid ac_simd_relu_backward(const float* a, const float* grad, float* c, ac_size n);\r\nvoid ac_simd_exp(const float* a, float* c, ac_size n);                    // c = exp(a)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"reductions",children:"Reductions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"float ac_simd_dot(const float* a, const float* b, ac_size n);  // dot product\r\nfloat ac_simd_sum(const float* a, ac_size n);                   // sum\r\nfloat ac_simd_max(const float* a, ac_size n);                   // max\n"})}),"\n",(0,s.jsx)(n.h2,{id:"gemm-general-matrix-multiply",children:"GEMM (General Matrix Multiply)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"void ac_gemm(const float* A, const float* B, float* C,\r\n             ac_size M, ac_size N, ac_size K);\r\n// C[M\xd7N] = A[M\xd7K] \xd7 B[K\xd7N]\n"})}),"\n",(0,s.jsx)(n.h3,{id:"blis-style-algorithm",children:"BLIS-style Algorithm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"5-loop blocking structure:\r\nLoop 1: N blocks (NC = 4096)\r\n  Loop 2: K blocks (KC = 256)\r\n    Pack B \u2192 B\u0303 [KC \xd7 NC, column-contiguous]\r\n    Loop 3: M blocks (MC = 72)\r\n      Pack A \u2192 \xc3 [MC \xd7 KC, row-contiguous]\r\n      Loop 4: NR tiles\r\n        Loop 5: MR tiles \u2192 micro-kernel\n"})}),"\n",(0,s.jsx)(n.h3,{id:"micro-kernels",children:"Micro-kernels"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Arch"}),(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Tile"}),(0,s.jsx)(n.th,{children:"Registers"}),(0,s.jsx)(n.th,{children:"Peak FMAs"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"AVX-512"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ac_micro_kernel_6x32"})}),(0,s.jsx)(n.td,{children:"6\xd732"}),(0,s.jsx)(n.td,{children:"12 ZMM"}),(0,s.jsx)(n.td,{children:"192/k-step"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"AVX2"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ac_micro_kernel_6x16"})}),(0,s.jsx)(n.td,{children:"6\xd716"}),(0,s.jsx)(n.td,{children:"12 YMM"}),(0,s.jsx)(n.td,{children:"96/k-step"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"NEON"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ac_micro_kernel_6x8_neon"})}),(0,s.jsx)(n.td,{children:"6\xd78"}),(0,s.jsx)(n.td,{children:"12 Q-reg"}),(0,s.jsx)(n.td,{children:"48/k-step"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Scalar"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ac_micro_kernel_scalar"})}),(0,s.jsx)(n.td,{children:"6\xd78"}),(0,s.jsx)(n.td,{children:"\u2014"}),(0,s.jsx)(n.td,{children:"Baseline"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"threading",children:"Threading"}),"\n",(0,s.jsx)(n.p,{children:"For large matrices (M \u2265 2\xd7MC), the M-loop is parallelized across the thread pool:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"// Automatic: single-thread for small, multi-thread for large\r\nif (M >= 2 * MC && g_thread_pool_initialized) {\r\n    // Parallel dispatch over M blocks\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"transpose",children:"Transpose"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"void ac_transpose(const float* src, float* dst, ac_size rows, ac_size cols);\r\n// 8\xd78 block-tiled for cache efficiency\n"})}),"\n",(0,s.jsx)(n.h2,{id:"fast-math-approximations",children:"Fast Math (Approximations)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"float ac_fast_exp(float x);     // Polynomial approximation (< 0.1% error)\r\nfloat ac_fast_tanh(float x);    // Based on fast_exp\r\nfloat ac_fast_sigmoid(float x); // 1 / (1 + fast_exp(-x))\n"})}),"\n",(0,s.jsx)(n.h3,{id:"neon-transcendentals",children:"NEON Transcendentals"}),"\n",(0,s.jsx)(n.p,{children:"On ARM platforms, vectorized versions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"float32x4_t ac_neon_exp(float32x4_t x);      // Cephes polynomial\r\nfloat32x4_t ac_neon_sigmoid(float32x4_t x);   // Exp + Newton-Raphson reciprocal\r\nfloat32x4_t ac_neon_tanh(float32x4_t x);      // 2*sigmoid(2x) - 1\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>c,x:()=>r});var a=t(6540);const s={},i=a.createContext(s);function c(e){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);